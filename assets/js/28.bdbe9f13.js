(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{524:function(e,r,t){"use strict";t.r(r);var a=t(2),n=Object(a.a)({},(function(){var e=this,r=e.$createElement,t=e._self._c||r;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("本文首发在我的博客："),t("a",{attrs:{href:"https://tuaran.github.io/views/2020/cgamemp.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("地址"),t("OutboundLink")],1)]),e._v(" "),t("h2",{attrs:{id:"小程序音视频原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小程序音视频原理"}},[e._v("#")]),e._v(" 小程序音视频原理")]),e._v(" "),t("h3",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言")]),e._v(" "),t("p",[e._v("首先你需要了解如何"),t("a",{attrs:{href:"https://cloud.tencent.com/document/product/647/32399",target:"_blank",rel:"noopener noreferrer"}},[e._v("《快速跑通Demo》"),t("OutboundLink")],1),e._v("，本云游戏小程序实现方案正是基于 "),t("strong",[e._v("TRTC")]),e._v(" 双人通话。")]),e._v(" "),t("p",[e._v("TRTC 互通的自定义组件是通过 "),t("strong",[e._v("<trtc-room>")]),e._v(" 标签实现，它基于微信小程序原生的<live-pusher> 和 <live-player> 两个媒体组件。")]),e._v(" "),t("p",[e._v("这里主要用到的是 "),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/component/live-player.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("live-player"),t("OutboundLink")],1),e._v("，用于播放云游戏的视频流。")]),e._v(" "),t("h3",{attrs:{id:"架构图"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#架构图"}},[e._v("#")]),e._v(" 架构图")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/09/15/2uZPJt7pYVNvdm8.png",alt:"yl.png"}})]),e._v(" "),t("p",[t("a",{attrs:{href:"https://developers.weixin.qq.com/community/develop/article/doc/0008ae6f288ee85cb1f7344f35b413",target:"_blank",rel:"noopener noreferrer"}},[e._v("图片来源"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("可以从上图看到：微信小程序实现音视频必须经过腾讯视频云做转码（计费）。")]),e._v(" "),t("h3",{attrs:{id:"要点说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#要点说明"}},[e._v("#")]),e._v(" 要点说明")]),e._v(" "),t("ol",[t("li",[t("p",[e._v("开发小程序音视频需要先通过类目审核。"),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/component/live-player.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("类目范围"),t("OutboundLink")],1)])]),e._v(" "),t("li",[t("p",[e._v("因为需要经过腾讯云的代理，所以需要注册腾讯云，申请 "),t("strong",[e._v("SDKAPPID")]),e._v(" 和 "),t("strong",[e._v("SECRETKEY")]),e._v(" 并做相应配置，前后端需统一。")])])]),e._v(" "),t("h2",{attrs:{id:"开发指引"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开发指引"}},[e._v("#")]),e._v(" 开发指引")]),e._v(" "),t("h3",{attrs:{id:"代码目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代码目录"}},[e._v("#")]),e._v(" 代码目录")]),e._v(" "),t("p",[e._v("本方案实现基于小程序原生，未使用框架（如 uniapp、taro 等）。")]),e._v(" "),t("p",[e._v("原生规范具体可参见："),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/reference/wxml/",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信官方文档-小程序"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("初始化目录：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/09/15/JWijS34a1LP7c9l.png",alt:"catalog.png"}})]),e._v(" "),t("h3",{attrs:{id:"开发步骤"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开发步骤"}},[e._v("#")]),e._v(" 开发步骤")]),e._v(" "),t("ol",[t("li",[e._v("GenerateTestUserSig.js 中配置"),t("strong",[e._v("SDKAPPID")]),e._v(" 和 "),t("strong",[e._v("SECRETKEY")]),e._v("，需和后台统一；")]),e._v(" "),t("li",[e._v("后台开视频房间，前端拿到房间号；")]),e._v(" "),t("li",[e._v("在微信开发者工具中打开项目，启用真机调试，扫码测试视频流是否推送成功；")]),e._v(" "),t("li",[e._v("前端获取用户点击和滑动操作；")]),e._v(" "),t("li",[e._v("websocket 对接，对字节流进行编码和解码；")]),e._v(" "),t("li",[e._v("流程完善；")])]),e._v(" "),t("p",[e._v("TODO:")]),e._v(" "),t("ol",[t("li",[e._v("心跳检测；")]),e._v(" "),t("li",[e._v("重连机制；")]),e._v(" "),t("li",[e._v("画面旋转；")]),e._v(" "),t("li",[e._v("接口对接；")]),e._v(" "),t("li",[e._v("断点续传；")]),e._v(" "),t("li",[e._v("......")])]),e._v(" "),t("h3",{attrs:{id:"编码和解码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#编码和解码"}},[e._v("#")]),e._v(" 编码和解码")]),e._v(" "),t("p",[e._v("需要用 base64 做中转，编码类型是： "),t("strong",[e._v("ascii 编码")]),e._v("。")]),e._v(" "),t("ul",[t("li",[e._v("接收数据（解码）：ArrayBuffer 转 String")])]),e._v(" "),t("ol",[t("li",[e._v("先将 Buffer 转 base64："),t("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/api/base/wx.arrayBufferToBase64.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("wx.arrayBufferToBase64"),t("OutboundLink")],1)]),e._v(" "),t("li",[e._v("再将 base64 转 String："),t("a",{attrs:{href:"https://www.cnblogs.com/Man-Dream-Necessary/p/8400376.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信小程序base64编码解码以及utf-8解码"),t("OutboundLink")],1)])]),e._v(" "),t("ul",[t("li",[e._v("发送数据（编码）：String 转 ArrayBuffer")])]),e._v(" "),t("ol",[t("li",[e._v("先将 String 转为 base 64；")]),e._v(" "),t("li",[e._v("再调用 wx.base64ToArrayBuffer 转成 ArrayBuffer")])]),e._v(" "),t("p",[e._v("此部分方法封装在 "),t("strong",[e._v("trtc-room-socket.js")]),e._v(" 文件中")]),e._v(" "),t("h3",{attrs:{id:"真机调试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#真机调试"}},[e._v("#")]),e._v(" 真机调试")]),e._v(" "),t("p",[e._v("开发者工具上无法看到视频流，必须启用手机来调试。真机调试可以看实时查看打印信息，查看延迟信息等；")]),e._v(" "),t("p",[e._v("当前推流房间号：9999")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://i.loli.net/2020/09/15/AkTnG4QNmHvFoEX.png",alt:"console.png"}})]),e._v(" "),t("h2",{attrs:{id:"后记"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#后记"}},[e._v("#")]),e._v(" 后记")]),e._v(" "),t("h3",{attrs:{id:"文档整理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#文档整理"}},[e._v("#")]),e._v(" 文档整理")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://cloud.tencent.com/document/product/647/32399",target:"_blank",rel:"noopener noreferrer"}},[e._v("一分钟跑通demo"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://cloud.tencent.com/document/product/647/32183",target:"_blank",rel:"noopener noreferrer"}},[e._v("快速集成组件"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://cloud.tencent.com/document/product/647/32226",target:"_blank",rel:"noopener noreferrer"}},[e._v("快速调通基本功能"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://cloud.tencent.com/document/product/647/17018",target:"_blank",rel:"noopener noreferrer"}},[e._v("trtc-room api"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://juejin.im/post/6844903647814352904",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信小程序实现WebSocket心跳重连"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1469900",target:"_blank",rel:"noopener noreferrer"}},[e._v("浅谈BASE64编码"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://juejin.im/post/6844903838286102536",target:"_blank",rel:"noopener noreferrer"}},[e._v("JS 中关于 base64 的一些事"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://html52.com/archives/190554.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("微信小程序ASCII转字符"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://learnku.com/docs/pymotw/base64-encode-binary-data-with-ascii/3435",target:"_blank",rel:"noopener noreferrer"}},[e._v("base64 — 使用 ASCII 编码二进制数据"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2008/06/base64.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Base64笔记"),t("OutboundLink")],1)])]),e._v(" "),t("h3",{attrs:{id:"错误收集"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#错误收集"}},[e._v("#")]),e._v(" 错误收集")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://blog.csdn.net/yyjjyysleep/article/details/81285107",target:"_blank",rel:"noopener noreferrer"}},[e._v("退出房间定时器未清空"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://developers.weixin.qq.com/community/develop/doc/000400144bc200c468984764851c00?_at=1558694357675",target:"_blank",rel:"noopener noreferrer"}},[e._v("sendSocketMessage: fail taskID not exist（关键）"),t("OutboundLink")],1)]),e._v(" "),t("li",[t("a",{attrs:{href:"https://developers.weixin.qq.com/community/develop/doc/6062f2fae9d598f8a5a1c884be668478",target:"_blank",rel:"noopener noreferrer"}},[e._v("小程序中使用btoa、atob方法"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);r.default=n.exports}}]);