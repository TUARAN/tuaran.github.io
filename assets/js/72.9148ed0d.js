(window.webpackJsonp=window.webpackJsonp||[]).push([[72],{573:function(s,n,t){"use strict";t.r(n);var a=t(2),e=Object(a.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("本篇译自："),t("a",{attrs:{href:"https://javascript.plainenglish.io/how-to-use-observables-with-vanilla-javascript-aca40a7590ff",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://javascript.plainenglish.io/how-to-use-observables-with-vanilla-javascript"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("接上两篇：")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://juejin.cn/post/7029093184332365855",target:"_blank",rel:"noopener noreferrer"}},[s._v("《Js 异步处理演进，Callback=>Promise=>Observer》"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://juejin.cn/post/7029465648174465055",target:"_blank",rel:"noopener noreferrer"}},[s._v("《继续解惑，异步处理 —— RxJS Observable》"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("我们认识了 ES7 处理异步的一大利器 —— "),t("strong",[t("code",[s._v("Observable")])])]),s._v(" "),t("p",[t("strong",[s._v("本篇带来用原生实现 Observable，一探内部究竟！！")])]),s._v(" "),t("p",[s._v("实现步骤解析如下：")]),s._v(" "),t("ol",[t("li",[s._v("Observable 应该是一个 "),t("strong",[s._v("Subject")]),s._v(" 新对象类型；")]),s._v(" "),t("li",[s._v("并且 "),t("strong",[s._v("Subject")]),s._v(" 对象有"),t("code",[s._v("subscribe")]),s._v("和"),t("code",[s._v("next")]),s._v("两个函数；")]),s._v(" "),t("li",[t("code",[s._v("subscribe")]),s._v(" 由 observers （观察者）调用，来订阅可观察的数据流；")]),s._v(" "),t("li",[t("code",[s._v("next")]),s._v("由 "),t("strong",[s._v("Subject owner")]),s._v(" 调用，实现推送/发布新数据；")]),s._v(" "),t("li",[t("strong",[s._v("Subject owner")]),s._v(" 应该知道 observers 何时监听数据生效；")]),s._v(" "),t("li",[s._v("另外，"),t("strong",[s._v("Subject owner")]),s._v(" 也应该知道 observers 何时不再监听了；")]),s._v(" "),t("li",[s._v("再看 observer，它也应该可以随时被取消；")]),s._v(" "),t("li",[s._v("可以定义一个新的对象，"),t("strong",[s._v("Subscription")]),s._v("；")]),s._v(" "),t("li",[t("strong",[s._v("Subscription")]),s._v(" 包含 "),t("code",[s._v("unsubscribe")]),s._v(" 函数；")]),s._v(" "),t("li",[s._v("每个 observer 想要停止监听来自 "),t("strong",[s._v("Subject")]),s._v(" 的数据流时，可以调用"),t("code",[s._v("unsubscribe")]),s._v("实现；")])]),s._v(" "),t("p",[s._v("有了以上思路之后，我们可以进一步来看代码实现~")]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("代码实现：")]),s._v(" "),t("p",[t("strong",[s._v("Subscription")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("let Subscription = function(handlerId, unsubscribeNotificationCallback) {\n\tlet self = this;\n\n\tself.unsubscribe = () => {\n\t\tif(unsubscribeNotificationCallback) {\n\t\t\tunsubscribeNotificationCallback(handlerId);\n\t\t}\n\t};\n\t\n\treturn self;\n};\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("注意："),t("strong",[s._v("Subscription")]),s._v(" 仅在 "),t("code",[s._v("unsubscribe")]),s._v(" 被调用时，通知 "),t("strong",[s._v("Subject")]),s._v("；")]),s._v(" "),t("hr"),s._v(" "),t("p",[s._v("再看 "),t("strong",[s._v("Subject")]),s._v(" 完整代码实现：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("let Subject = function(subscribersStateChangeNotificationCallback) {\n\tlet self = this;\n\t\n\tlet handlers = {};\n\t\n\tObject.defineProperty(self, \"subscribersFound\", {\n\t\tget() {\n\t\t\tlet found = false;\n\t\t\t\n\t\t\tfor(const prop in handlers) {\n\t\t\t\tif(handlers.hasOwnProperty(prop)) {\n\t\t\t\t\tfound = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\treturn found;\n\t\t}\n\t});\n\t\n\tObject.defineProperty(self, \"subscribersCount\", {\n\t\tget() {\n\t\t\tlet count = 0;\n\t\t\t\n\t\t\tfor(const prop in handlers) {\n\t\t\t\tif(handlers.hasOwnProperty(prop)) {\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\treturn count;\n\t\t}\n\t});\n\t\n\tlet unsubscribeNotificationCallback = (handlerId) => {\n\t\tif(handlerId && handlerId !== '' && handlers.hasOwnProperty(handlerId)) {\n\t\t\tdelete handlers[handlerId];\n\t\t\t\n\t\t\tif(subscribersStateChangeNotificationCallback && !self.subscribersFound) {\n\t\t\t\tsubscribersStateChangeNotificationCallback(false);\n\t\t\t}\n\t\t}\n\t};\n\t\n\tself.subscribe = (handler) => {\n\t\tlet handlerId = createGuid();\n\t\thandlers[handlerId] = handler;\n\t\t\n\t\tif(subscribersStateChangeNotificationCallback && self.subscribersCount === 1) {\n\t\t\tsubscribersStateChangeNotificationCallback(true);\n\t\t}\n\t\t\n\t\treturn new Subscription(handlerId, unsubscribeNotificationCallback);\n\t};\n\t\n\tself.next = (data) => {\n\t\tfor(const handlerId in handlers) {\n\t\t\thandlers[handlerId](data);\n\t\t}\n\t};\n\t\n\treturn self;\n};\n\nlet createGuid = function() {  \n   return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {  \n      var r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);  \n      return v.toString(16);  \n   });  \n};\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br")])]),t("p",[t("strong",[s._v("Subject Owner")]),s._v(" 实现：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(".\n.\n.\nlet subscribersStateChangeNotificationCallback = (subscriberFound) => {\n\tif(!subscriberFound && isNowWatching) {\n\t\tstopWatching();\n\t\tisNowWatching = false;\n\t} else if(subscriberFound && !isNowWatching) {\n\t\tstartWatching();\n\t}\n};\n\nself.data = new Subject(subscribersStateChangeNotificationCallback);\n.\n.\n.\nself.data.next(self.snapshot.data);\n.\n.\n.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("p",[t("strong",[s._v("Observer")]),s._v(" 实现：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(".\n.\n.\nconst dashboardServiceSubscription = myDashboardService.data.subscribe((data) => {\n\t...\n});\n.\n.\n.\ndashboardServiceSubscription.unsubscribe();\n.\n.\n.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("小结：我们可以看到实现关键是 "),t("strong",[s._v("Subject")]),s._v(" 对象，更重要的是 "),t("strong",[s._v("发布")]),s._v(" 和 "),t("strong",[s._v("订阅")]),s._v(" 的过程！当然，也不能忘了 "),t("strong",[s._v("取消订阅")]),s._v(" 的功能；")]),s._v(" "),t("p",[s._v("发布和订阅模式来处理异步可以忽视掉时间这个维度，就是不用管时间上的先后，就保证了顺序！这一点，在前面一篇函数式编程中也讲过："),t("a",{attrs:{href:"https://juejin.cn/post/6976550771122765837#heading-1",target:"_blank",rel:"noopener noreferrer"}},[s._v("《XDM，JS如何函数式编程？看这就够了！（六）》"),t("OutboundLink")],1),s._v(" —— "),t("strong",[s._v("减少时间状态！")])]),s._v(" "),t("p",[s._v('不得不说，都是相通的~~ Σ(⊙▽⊙"a')]),s._v(" "),t("hr"),s._v("\nOK，就是这样！这就是用原生模拟 Observable 的实现过程！\n"),t("p",[s._v("撰文不易，点赞鼓励👍👍👍👍👍👍")]),s._v(" "),t("blockquote",[t("p",[s._v("我是掘金安东尼，公众号同名，日拱一卒、日掘一金，再会~")])])])}),[],!1,null,null,null);n.default=e.exports}}]);