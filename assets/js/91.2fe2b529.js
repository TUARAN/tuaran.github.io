(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{588:function(s,n,a){"use strict";a.r(n);var e=a(2),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("我们经常会遇到这样的需求，在循环中使用异步请求 async/await。")]),s._v(" "),a("p",[s._v("本篇总结了 5 种使用方法：")]),s._v(" "),a("ul",[a("li",[s._v("打勾的方法 ✔ ：表示在循环中每个异步请求是按照次序来执行的，我们简称为 "),a("strong",[s._v("“串行”")])]),s._v(" "),a("li",[s._v("打叉的方法❌：代表在循环中执行了所有异步请求，不保证次序，我们简称为 "),a("strong",[s._v("“并行”")])])]),s._v(" "),a("p",[s._v("按需所取，点赞👍收藏📕")]),s._v(" "),a("h2",{attrs:{id:"foreach-❌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#foreach-❌"}},[s._v("#")]),s._v(" forEach ❌")]),s._v(" "),a("p",[s._v("遍历我们常用 forEach，用 forEach 可以吗？")]),s._v(" "),a("p",[s._v("首先要明确的是，本质上 forEach 就是一个 for 循环的包装。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Array.prototype.forEach = function (callback) {\n  for (let index = 0; index < this.length; index++) {\n    callback(this[index], index, this)\n  }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("在回调函数内部调用 await 需要这个回调函数本身也是 async 函数，所以循环中的代码应这样写：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("async function someFunction(items) {\n  items.forEach( async(i) => {\n     const res = await someAPICall(i);\n     console.log('---\x3e', res);\n  });\n}\nfunction someAPICall(param) {\n    return new Promise((resolve, reject)=>{\n      setTimeout(()=>{\n        resolve(\"Resolved\" + param)\n      },param);\n    })\n}\nsomeFunction(['3000','8000','1000','4000']);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("在控制台执行，如图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/2021/async-await-loop/async1.png",alt:""}})]),s._v(" "),a("p",[s._v("我们可以看到 forEach 并没有按照我们的期望进行输出。forEach 只是按顺序并行执行了，而不是串行。而用 for...of 却符合我们的要求。")]),s._v(" "),a("h2",{attrs:{id:"for-of-✔"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#for-of-✔"}},[s._v("#")]),s._v(" for...of... ✔")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("async function printFiles () {\n  let fileNames = ['picard', 'kirk', 'geordy', 'ryker', 'worf'];\n  for (const file of fileNames) {\n    const contents = await fs.readFile(file, 'utf8');\n    console.log(contents);\n  }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("控制台执行如下图：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/2021/async-await-loop/async2.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"reduce-✔"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#reduce-✔"}},[s._v("#")]),s._v(" reduce ✔")]),s._v(" "),a("p",[s._v("其实有了解过【循环】+【异步】的童鞋肯定知道 reduce。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('function testPromise(time) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      console.log(`Processing ${time}`);\n      resolve(time);\n    }, time);\n  });\n}\n\nlet result = [3000,2000,1000, 4000].reduce( (accumulatorPromise, nextID) => {\n  return accumulatorPromise.then(() => {\n    return testPromise(nextID);\n  });\n}, Promise.resolve());\n\nresult.then(e => {\n  console.log("All Promises Resolved !!✨")\n});\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("我们可以使用 reduce 函数来遍历数组并按顺序 resolve promise。")]),s._v(" "),a("p",[s._v("很清晰！")]),s._v(" "),a("h2",{attrs:{id:"generator-✔"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#generator-✔"}},[s._v("#")]),s._v(" generator ✔")]),s._v(" "),a("p",[s._v("其实用 async generator 也是可以的。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("async function* readFiles(files) {\n  for(const file of files) {\n    yield await readFile(file);\n  }\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("针对上例，代码如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("async function* generateSequence(items) {\n  for (const i of items) {\n    await new Promise(resolve => setTimeout(resolve, i));\n    yield i;\n  }\n}\n\n(async () => {\n  let generator = generateSequence(['3000','8000','1000','4000']);\n  for await (let value of generator) {\n    console.log(value);\n  }\n})();\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h2",{attrs:{id:"promise-all-❌"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#promise-all-❌"}},[s._v("#")]),s._v(" Promise.all() ❌")]),s._v(" "),a("p",[s._v("如果你不用考虑异步请求的执行顺序，你可以选择 Promise.all()，即 Promise.all() 可以达到"),a("strong",[s._v("并行")]),s._v(" 而非"),a("strong",[s._v("串行")]),s._v("的目的。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("async function printFiles () {\n  let fileNames = ['picard', 'kirk', 'geordy', 'ryker', 'worf'];\n  await Promise.all(fileNames.map(async (file) => {\n    const contents = await fs.readFile(file, 'utf8');\n    console.log(contents);\n  }));\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("针对上例，代码如下：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("async function promiseAll(arr) {\n  await Promise.all(arr.map(async (i) => {\n    await sleep(i)\n    console.log('---\x3e', i);\n  }))\n}\n\nfunction sleep(i) {\n  return new Promise((resolve, reject) => {\n    setTimeout(() => {\n      resolve()\n    }, i)\n  })\n}\n\npromiseAll(['3000','8000','1000','4000'])\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);