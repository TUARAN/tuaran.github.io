(window.webpackJsonp=window.webpackJsonp||[]).push([[126],{620:function(s,n,a){"use strict";a.r(n);var e=a(2),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"序言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#序言"}},[s._v("#")]),s._v(" 序言")]),s._v(" "),a("p",[s._v("现如今，我们总是在无止境的刷。刷微博、刷抖音、刷沸点......一次次丝滑下拉体验的背后却是前端攻城狮的用心。")]),s._v(" "),a("p",[s._v("本篇讨论基于 Vue.js 的列表“无限下拉”实践。")]),s._v(" "),a("p",[s._v("我们的目标就是："),a("strong",[s._v("让列表下拉纵享丝滑")]),s._v("，而不是像以往的下拉就 loading 等待的体验。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://betterprogramming.pub/how-to-create-smooth-endless-scrolling-in-vue-js-4fc9180645ef",target:"_blank",rel:"noopener noreferrer"}},[s._v("译自 Better Programming"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://codesandbox.io/s/live-demo-virtual-list-e1ww1",target:"_blank",rel:"noopener noreferrer"}},[s._v("在线 Demo"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设计"}},[s._v("#")]),s._v(" 设计")]),s._v(" "),a("p",[s._v("咱还是用 Vue CLI 来快速构建项目。")]),s._v(" "),a("p",[s._v("这是主页面：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<template>\n  <div class="endless-scrolling-list">\n    \x3c!-- 搜索框 --\x3e\n    <div class="search-box">\n      <input type="text" v-model="searchQuery"/>\n    </div>\n    <p class="center" v-if="results.length == 0 && !loading">\n      Start typing to search something.\n    </p>\n    \x3c!-- 虚拟列表 --\x3e\n    <virtual-list\n      :data-key="\'pageid\'"\n      :data-sources="results"\n      :data-component="itemComponent"\n      :page-mode="true"\n      />\n    \x3c!-- loading --\x3e\n    <loader v-if="loading" />\n  </div>\n</template>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("其中核心当然是"),a("code",[s._v("virtual-list")]),s._v("组件啦~")]),s._v(" "),a("p",[s._v("这里的虚拟列表，我们用到一个三方库 "),a("a",{attrs:{href:"https://github.com/tangbc/vue-virtual-scroll-list",target:"_blank",rel:"noopener noreferrer"}},[s._v("Vue Virtual Scroll List"),a("OutboundLink")],1),s._v("，它在 Github 上又 2.5k+ 的 stars。好比 react 的 "),a("a",{attrs:{href:"https://github.com/bvaughn/react-virtualized",target:"_blank",rel:"noopener noreferrer"}},[s._v("react-virtualized"),a("OutboundLink")],1),s._v(" 库。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/2021/smoothScroll/1_FvTYWsUGUJJ4VwJabqrbAA.png",alt:""}})]),s._v(" "),a("p",[s._v("大量的 DOM 元素会使得我们的网页非常“重”。当 DOM 元素超过 1500 至 2000 个的时候，页面就开始又延迟，尤其是在小型的设备上。")]),s._v(" "),a("p",[s._v("想象一下，有一个无线滚动的页面，你不断的下拉，它实际上可能形成了上万个 DOM 元素，每个元素还包含子节点，这样将消耗巨大的性能。")]),s._v(" "),a("p",[s._v("Virtual scrollers 正是来解决这个问题的。")]),s._v(" "),a("p",[s._v("如上图，已经表示的很清楚了。列表分为可见区域和缓冲区域，超出这个范围的列表 DOM 都将被删除。")]),s._v(" "),a("p",[s._v("准备工作已就绪，Let`s get it!")]),s._v(" "),a("h2",{attrs:{id:"实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[s._v("#")]),s._v(" 实现")]),s._v(" "),a("p",[s._v("// imports.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import axios from 'axios';\nimport lodash from 'lodash';\nimport VirtualList from 'vue-virtual-scroll-list';\nimport SearchResult from './SearchResult';\nimport Loader from './Loader';\nexport default {\n  name: 'EndlessList',\n  components: {\n    VirtualList,\n    Loader\n  },\n  data() {\n    return {\n      searchQuery: '',\n      currentPage: 0,\n      results: [],\n      itemComponent: SearchResult,\n      loading: false\n    }\n  },\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("我们引入第三方库 axios 和 loadsh，以便后续使用。")]),s._v(" "),a("p",[a("code",[s._v("itemComponent")]),s._v(" 是 virtual-list 的属性，为此我们需要新建一个 "),a("code",[s._v("SearchResult")]),s._v(" 子组件。")]),s._v(" "),a("p",[s._v("代码如下：")]),s._v(" "),a("p",[s._v("// SearchResult.vue")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<template>\n  <div class="list-item">\n    <h3>\n      {{ source.title }}\n    </h3>\n    <div v-html="source.snippet"></div>\n  </div>\n</template>\n\n<script>\nexport default {\n  props: {\n    index: {\n      // index of current item\n      type: Number,\n    },\n    source: {\n      type: Object,\n      default() {\n        return {};\n      },\n    },\n  },\n};\n<\/script>\n\n<style scoped>\n.list-item {\n  padding: 0 10px 20px 10px;\n}\n.list-item h3 {\n  margin: 0;\n  padding-bottom: 10px;\n}\n</style>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("p",[s._v("我们可以通过搜索标题或描述来得到结果，请求数据来源于维基百科。")]),s._v(" "),a("p",[s._v("// search.js")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('search(query, page) {\n  // We prepare the data that the Wikipedia API expects.\n  const data = {\n    action: "query",\n    format: "json",\n    list: "search",\n    continue: "-||",\n    utf8: 1,\n    srsearch: query,\n    sroffset: page * 10,\n    origin: "*",\n  };\n  // And then we convert these params TO GET params in the format\n  // action=query&format=json ...\n  const params = Object.keys(data)\n    .map(function(k) {\n      return data[k] == ""\n        ? ""\n        : encodeURIComponent(k) + "=" + encodeURIComponent(data[k]);\n    })\n    .join("&");\n  // We prepare the url with the params string\n  const searchUrl = `https://en.wikipedia.org/w/api.php?${params}`;\n  // we set loading to true so that we can display the loader \n  this.loading = true;\n  // Then we execute the request and concatenate the results\n  axios.get(searchUrl).then((response) => {\n    this.results = this.results.concat(response.data.query.search);\n    // And of course set loading to false to hide the loader.\n    this.loading = false;\n  });\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("搜索的方法已经写好，接着就是"),a("strong",[s._v("调用")]),s._v("。")]),s._v(" "),a("ol",[a("li",[s._v("当用户键入内容的搜索时候会调用。")]),s._v(" "),a("li",[s._v("当下拉的时候会调用。")])]),s._v(" "),a("p",[s._v("// EndlessList.vue")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('<script>\nexport default {\n  // data() and methods skipped for brevity\n  watch: {\n    searchQuery: {\n      immediate: true,\n      handler: lodash.debounce(function (newVal) {\n        if (newVal == "") {\n          return;\n        }\n        this.results = [];\n        this.currentPage = 0;\n        this.search(newVal, this.currentPage);\n        this.search(newVal, this.currentPage + 1);\n        this.currentPage = 2;\n      }, 200),\n    },\n  },\n  mounted() {\n    const vm = this;\n    window.onscroll = lodash.debounce(function () {\n      var distanceFromBottom =\n        document.body.scrollHeight - window.innerHeight - window.scrollY;\n      if (distanceFromBottom < 400 && vm.searchQuery !== "") {\n        vm.search(vm.searchQuery, vm.currentPage);\n        vm.currentPage++;\n      }\n    }, 100, {leading: true});\n  },\n}\n<\/script>\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("p",[s._v("当 "),a("code",[s._v("searchQuery")]),s._v(" 变化的时候，我们会得到新的搜索结果。当然，这里的输入框也用到了防抖函数。")]),s._v(" "),a("p",[s._v("另一个需要注意的是，我们第一次搜索加载了两页的结果，用户就会有一定的滚动空间，这样就可以保持顺畅的感觉。")]),s._v(" "),a("p",[s._v("我们在滚动的事件中也加了防抖函数。这里设一个疑问：为什么要在 "),a("code",[s._v("window.onscroll")]),s._v(" 事件下设置 "),a("code",[s._v("leading")]),s._v(" 为 "),a("code",[s._v("true")]),s._v(" ？")]),s._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/2021/smoothScroll/_20210310154728.png",alt:""}})]),s._v(" "),a("p",[s._v("然后我们运行程序看效果")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm run dev\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:"/assets/img/2021/smoothScroll/1_08L0WmYbqncJJ765_27SSQ.gif",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("p",[s._v("此篇文章的目的就是让你体会"),a("strong",[s._v("无限下拉")]),s._v("的完整实践。用户不会希望每下拉十条结果就等待一下新的十条结果加载出来！所以我们需要有缓冲区，还会到底的时候就预判它到底然后提前加载。这便是丝滑体验的内核。")]),s._v(" "),a("p",[s._v("这样动态的处理列表的确是编程人员的一种智慧和用心。")]),s._v(" "),a("p",[s._v("你可以把 "),a("a",{attrs:{href:"https://github.com/arisp8/vue-endless-scrolling",target:"_blank",rel:"noopener noreferrer"}},[s._v("项目"),a("OutboundLink")],1),s._v(" 克隆到本地再体会一下。")]),s._v(" "),a("p",[s._v("以上便是本次分享。")]),s._v(" "),a("p",[s._v("撰文不易，点赞鼓励！(●'◡'●) 我是掘金安东尼，关注公众号【掘金安东尼】，有更多精彩分享~")])])}),[],!1,null,null,null);n.default=t.exports}}]);